{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastFood POS System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'menu/css/pos.css' %}">
</head>

<body>
    <div class="notification" id="notification"></div>

    <div class="container">
        <!-- Menu Section -->
        <div class="menu-section">
            <div class="menu-hero">
                <div>
                    <p style="letter-spacing: 2px; font-size: 12px; text-transform: uppercase; opacity: 0.8;">Shirin •
                        Tez • Dostona</p>
                    <h1>AKA_UKA_FAST-FOOD</h1>
                </div>
                <div class="menu-hero-cta">
                    <a href="/admin/" class="admin-link">Admin Panel</a>
                    <a href="/orders/report/" class="report-link">Hisobot</a>
                </div>
            </div>

            <div class="search-container">
                <div class="search-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="menu-search" placeholder="Ovqat qidirish..." class="search-input">
                </div>
            </div>

            <div class="category-tabs">
                <button class="category-tab active" data-category="all">Hammasi</button>
                {% for category in categories %}
                <button class="category-tab" data-category="{{ category.id }}">{{ category.name }}</button>
                {% endfor %}
            </div>

            <div class="menu-grid" id="menu-grid">
                <!-- Menu items will be populated by JavaScript -->
            </div>
        </div>

        <!-- Order Section -->
        <div class="order-section">
            <div class="order-header">
                <h2>Hozirgi</h2>
                <div class="order-number">Buyurtma #<span id="order-number">{{active_order.display_order_number}}</span>
                </div>
            </div>

            <div class="order-items" id="order-items">
                <!-- Order items will be dynamically populated -->
                {% for item in order_items %}
                <div class="order-item" data-id="{{ item.id }}">
                    <div class="item-details">
                        <div class="item-name">{{ item.item_name }}</div>
                    </div>
                    <div class="item-quantity">{{ item.quantity }}</div>
                    <div class="item-price">{{ item.subtotal }}</div>
                    <button class="remove-btn" data-item-id="{{ item.id }}"
                        onclick="removeOrderItem(this.dataset.itemId)">×</button>
                </div>
                {% endfor %}
                {% if not order_items %}
                <div class="empty-order">Hech narsa yoq</div>
                {% endif %}
            </div>

            <div class="order-total">
                Total: <span id="order-total">{{ active_order.total_amount|default:"0" }}</span>
            </div>

            <div class="order-actions">
                <button class="action-btn clear-btn" onclick="clearOrder()">Tozalash</button>
                <button class="action-btn checkout-btn" id="checkout-btn" {% if not order_items %}disabled{% endif %}>
                    Zakaz
                </button>
            </div>
        </div>
    </div>

    {{ menu_payload|json_script:"menu-items-data" }}
    <script>
        const menuItems = JSON.parse(document.getElementById('menu-items-data').textContent);
        let currentCategory = 'all';
        let searchQuery = '';

        function initializeMenu() {
            renderMenuItems();
            setupCategoryTabs();
        }

        function renderMenuItems() {
            const menuGrid = document.getElementById('menu-grid');
            const filteredItems = menuItems.filter(item => {
                const matchesCategory = currentCategory === 'all' || String(item.category) === currentCategory;
                const matchesSearch = item.name.toLowerCase().includes(searchQuery.toLowerCase());
                return matchesCategory && matchesSearch;
            });

            menuGrid.innerHTML = filteredItems.map(item => `
                <div class="menu-item" onclick="addToOrder(${item.id})">
                    <img class="menu-item-photo" src="${item.image_url}" alt="${item.name}">
                    <div class="menu-item-body">
                        <div>
                            <h3>${item.name}</h3>
                            <p>${item.description || 'Chef special served hot.'}</p>
                        </div>
                        <div class="menu-meta-row">
                            <span class="price">${parseInt(item.price)}</span>
                            <div class="quantity-control">
                                <button class="quantity-btn minus" onclick="event.stopPropagation(); adjustQuantity(this, -1)">-</button>
                                <input type="text" class="quantity-input" value="1" readonly>
                                <button class="quantity-btn plus" onclick="event.stopPropagation(); adjustQuantity(this, 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setupCategoryTabs() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.getAttribute('data-category');
                    renderMenuItems();
                });
            });
        }

        function setupSearch() {
            const searchInput = document.getElementById('menu-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value;
                    renderMenuItems();
                });
            }
        }

        function adjustQuantity(button, change) {
            const control = button.closest('.quantity-control');
            const input = control.querySelector('.quantity-input');
            let value = parseInt(input.value);
            value = Math.max(1, value + change);
            input.value = value;
        }

        function addToOrder(itemId) {
            const menuItem = document.querySelector(`.menu-item[onclick="addToOrder(${itemId})"]`);
            const quantity = parseInt(menuItem.querySelector('.quantity-input').value);

            fetch('/api/add-to-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    item_id: itemId,
                    item_type: 'item',
                    quantity: quantity
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateOrderDisplay(data.order);
                        showNotification('Buyurtma qo‘shildi!', 'success');
                        menuItem.querySelector('.quantity-input').value = 1;
                    } else {
                        showNotification('Xato: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Network xato: ' + error, 'error');
                });
        }

        function removeOrderItem(itemId) {
            fetch('/api/remove-order-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ item_id: itemId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`.order-item[data-id="${itemId}"]`)?.remove();
                        updateOrderTotal(data.total_amount);
                        checkEmptyOrder();
                        showNotification('Tozalandi', 'success');
                    } else {
                        showNotification('Xato: ' + data.error, 'error');
                    }
                });
        }

        function clearOrder() {
            if (!confirm('Hammasini tozlash kerakmi?')) return;

            fetch('/api/clear-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('order-items').innerHTML = '<div class="empty-order">Hech narsa yoq</div>';
                        updateOrderTotal('0.00');
                        document.getElementById('checkout-btn').disabled = true;
                        showNotification('Buyurtma tozalandi', 'success');
                    } else {
                        showNotification('Xato: ' + data.error, 'error');
                    }
                });
        }

        document.getElementById('checkout-btn').addEventListener('click', function () {
            if (this.disabled) return;

            fetch('/api/checkout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.receipt_url) {
                            window.open(data.receipt_url, '_blank');
                        }
                        showNotification(data.message, 'success');
                        document.getElementById('order-items').innerHTML = '<div class="empty-order">Hech narsa yoq</div>';
                        updateOrderTotal('0.00');
                        document.getElementById('checkout-btn').disabled = true;
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showNotification('Xato: ' + data.error, 'error');
                    }
                });
        });

        function updateOrderDisplay(orderData) {
            const orderItems = document.getElementById('order-items');
            let itemsHTML = '';

            orderData.items.forEach(item => {
                itemsHTML += `
                    <div class="order-item" data-id="${item.id}">
                        <div class="item-details">
                            <div class="item-name">${item.item_name}</div>
                        </div>
                        <div class="item-quantity">${item.quantity}</div>
                        <div class="item-price">${(item.quantity * parseInt(item.price))}</div>
                        <button class="remove-btn" onclick="removeOrderItem(${item.id})">×</button>
                    </div>
                `;
            });

            orderItems.innerHTML = itemsHTML || '<div class="empty-order">Hech narsa yoq</div>';
            updateOrderTotal(orderData.total_amount);
            document.getElementById('order-number').textContent = orderData.display_order_number || orderData.order_number;
            document.getElementById('checkout-btn').disabled = orderData.total_amount === '0.00';
        }

        function updateOrderTotal(total) {
            document.getElementById('order-total').textContent = parseFloat(total).toFixed(2);
        }

        function checkEmptyOrder() {
            const orderItems = document.getElementById('order-items');
            const hasItems = orderItems.querySelector('.order-item');
            if (!hasItems) {
                orderItems.innerHTML = '<div class="empty-order">Hech narsa yoq</div>';
                document.getElementById('checkout-btn').disabled = true;
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeMenu();
            setupSearch();
        });
    </script>
</body>

</html>